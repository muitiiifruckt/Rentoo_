# Rentoo Backend

## Описание сервиса

**Rentoo** — платформа для аренды вещей (шеринг-экономика), которая соединяет владельцев вещей с людьми, которым нужны эти вещи на время. Платформа обеспечивает безопасную и удобную аренду любых товаров: от спортивного инвентаря до бытовой техники и профессионального оборудования.

### Основная концепция

Rentoo решает проблемы традиционной аренды:
- **Для арендаторов**: сложный поиск, отсутствие доверия, небезопасная оплата, плохая коммуникация
- **Для арендодателей**: отсутствие аудитории, сложности с управлением заявками, риски при передаче вещей

### Целевая аудитория

Пользователи платформы могут одновременно:
- Сдавать свои вещи в аренду (когда не используют их)
- Арендовать вещи у других (когда нужны на короткий срок)

Один пользователь может быть и арендодателем, и арендатором в зависимости от ситуации.

---

## Основной функционал

### 1. Управление пользователями

#### Функции пользователей
- Регистрация и авторизация по email и паролю
- Профиль пользователя с фото
- Пользователь может одновременно:
  - Размещать объявления и сдавать вещи в аренду
  - Искать вещи и бронировать их для аренды
- История бронирований (rentals) - как владельца товара, так и арендатора

### 2. Управление товарами (Items)

#### Создание объявления
- Название товара
- Описание
- Категория (спорт, техника, инструменты, и т.д.)
- Фотографии (несколько фото)
- Цена за день/неделю/месяц
- Локация (адрес, координаты)
- Параметры (размеры, вес, характеристики)
- Условия аренды

#### Управление доступностью
- Календарь доступности (отметка свободных/занятых дат)
- Автоматическое обновление календаря при бронировании
- Возможность блокировать даты вручную

#### Статусы товара
- `draft` — черновик
- `active` — активно, доступно для бронирования
- `inactive` — временно недоступно
- `archived` — архивное объявление

### 3. Поиск и фильтрация

#### Параметры поиска (базовые)
- Текст (поиск по названию и описанию)
- Категория
- Цена (мин/макс)
- Локация (город/адрес)

#### Сортировка
- По дате добавления (новые сначала)
- По цене (возрастание/убывание)

### 4. Система бронирования

#### Процесс бронирования (rental)
1. Пользователь выбирает товар и даты
2. Создается заявка на бронирование (rental)
3. Владелец товара получает уведомление
4. Владелец подтверждает или отклоняет заявку
5. При подтверждении создается бронирование (rental)
6. Пользователи договариваются о встрече через чат
7. Оплата происходит при личной встрече (наличными или переводом)
8. После завершения аренды бронирование помечается как завершенное

#### Статусы бронирования (rental)
- `pending` — ожидает подтверждения
- `confirmed` — подтверждено владельцем
- `in_progress` — аренда идет
- `completed` — аренда завершена
- `cancelled` — отменено

#### Данные бронирования (rental)
- ID товара (item_id)
- ID арендатора (renter_id)
- ID владельца (owner_id)
- Даты начала и окончания
- Общая стоимость (для информации)
- Условия передачи/возврата
- Фото состояния товара при передаче/возврате (опционально)

### 5. Коммуникация

#### Чат между пользователями
- Личные сообщения между пользователями
- Привязка к конкретному бронированию (rental)
- История переписки
- Уведомления о новых сообщениях
- Возможность отправки фото (состояние товара)

#### Уведомления (базовые)
- In-app уведомления (в приложении)
- Типы: новые заявки на бронирование (rental), новые сообщения в чате

---

## Технические требования к бэкенду

### Архитектура

Рекомендуется использовать:
- **Монолитная архитектура** (для MVP)
- **REST API** для фронтенда
- **WebSocket** для чата (real-time сообщения)
- **Все на одном сервере**: приложение, БД, файлы

### Основные модули

#### 1. Authentication & Authorization
- JWT токены для авторизации
- Регистрация и вход по email + пароль
- Хеширование паролей (bcrypt)

#### 2. User Management
- CRUD операции для пользователей
- Профили пользователей
- Загрузка аватара

#### 3. Item Management
- CRUD операции для товаров
- Загрузка и хранение изображений (локально на сервере)
- Управление календарем доступности
- Категории и теги

#### 4. Search & Discovery
- Простой текстовый поиск по MongoDB (текстовые индексы или regex)
- Фильтрация по категории и цене
- Сортировка по дате и цене

#### 5. Rental System (Система бронирований)
- Создание и управление бронированиями
- Проверка доступности дат
- Автоматическое обновление календаря
- Управление статусами
- История бронирований

#### 6. Messaging System
- Чат между пользователями (WebSocket для real-time через FastAPI)
- История сообщений (хранится в MongoDB)
- Отправка текстовых сообщений
- Фото в сообщениях (опционально)

#### 7. Notification System
- In-app уведомления (хранятся в БД)
- Простые типы: новая заявка, новое сообщение
- Отметка прочитанным

### База данных

#### Коллекции MongoDB

**users**
- _id (ObjectId), email, password_hash, name, avatar_url
- created_at, updated_at

**items**
- _id (ObjectId), owner_id (ObjectId), title, description, category
- price_per_day, price_per_week, price_per_month
- location (address, lat, lng), parameters (dict)
- images (массив URL), status
- created_at, updated_at

**rentals** (бронирования)
- _id (ObjectId), item_id (ObjectId), renter_id (ObjectId), owner_id (ObjectId)
- start_date, end_date, total_price, status
- created_at, updated_at

**categories**
- _id (ObjectId), name, slug, description

**availability_calendar**
- _id (ObjectId), item_id (ObjectId), date, available, rental_id (ObjectId, nullable)

**messages**
- _id (ObjectId), rental_id (ObjectId), sender_id (ObjectId), receiver_id (ObjectId)
- content, type (text/image), read_at, created_at

**notifications**
- _id (ObjectId), user_id (ObjectId), type, title, content, read_at, created_at

### Технологический стек (рекомендации)

#### Backend Framework
- **Python** с **FastAPI**
- **Motor** (асинхронный драйвер) для работы с MongoDB
- **Pydantic** для валидации данных
- **Async/await** для асинхронных операций

#### База данных
- **MongoDB** — основная БД
- Все на одном сервере (БД и приложение)

#### Хранилище файлов
- Локальное хранилище на сервере (папка `uploads/` или `static/`)
- Изображения сохраняются на диске сервера
- Без CDN (для MVP достаточно)

#### Очереди задач
- Для MVP можно обойтись без очередей
- Загрузка изображений синхронная (или простая фоновая обработка через asyncio)

#### Платежи
- В MVP оплата происходит при личной встрече (наличными или переводом)
- Интеграция с платежными провайдерами планируется в будущих версиях

#### Real-time
- **WebSocket** (FastAPI поддерживает WebSocket)
- Polling для уведомлений (проще для MVP) или WebSocket через FastAPI

#### Мониторинг и логирование
- Базовое логирование через стандартный Python logging
- Логи в файлы на сервере
- **Sentry** для отслеживания ошибок (опционально)

### API Endpoints (основные)

#### Authentication
- `POST /api/auth/register` — регистрация
- `POST /api/auth/login` — вход
- `POST /api/auth/refresh` — обновление токена
- `POST /api/auth/logout` — выход
- `GET /api/auth/me` — текущий пользователь

#### Users
- `GET /api/users/:id` — профиль пользователя
- `PUT /api/users/:id` — обновление профиля

#### Items
- `GET /api/items` — список товаров (с фильтрами)
- `GET /api/items/:id` — детали товара
- `POST /api/items` — создание объявления
- `PUT /api/items/:id` — обновление
- `DELETE /api/items/:id` — удаление
- `GET /api/items/:id/availability` — календарь доступности
- `PUT /api/items/:id/availability` — обновление календаря

#### Rentals (Бронирования)
- `GET /api/rentals` — список бронирований пользователя
- `GET /api/rentals/:id` — детали бронирования
- `POST /api/rentals` — создание заявки
- `PUT /api/rentals/:id/confirm` — подтверждение
- `PUT /api/rentals/:id/cancel` — отмена
- `PUT /api/rentals/:id/complete` — завершение аренды

#### Messages
- `GET /api/rentals/:id/messages` — история сообщений
- `POST /api/rentals/:id/messages` — отправка сообщения
- `PUT /api/messages/:id/read` — отметка прочитанным

#### Notifications
- `GET /api/notifications` — список уведомлений
- `PUT /api/notifications/:id/read` — отметка прочитанным

### Безопасность

- HTTPS обязателен
- Валидация всех входных данных
- Защита от SQL-инъекций, XSS, CSRF
- Rate limiting для API
- Шифрование чувствительных данных
- Логирование подозрительной активности
- Регулярные аудиты безопасности

### Масштабируемость

Для MVP:
- Оптимизация запросов к БД (индексы)
- Асинхронная обработка через FastAPI (asyncio)
- Статические файлы отдаются через FastAPI или nginx

Для будущего масштабирования:
- Горизонтальное масштабирование
- Кэширование (Redis)
- CDN для статических файлов
- Load balancing

### Тестирование

- Unit тесты для бизнес-логики
- Integration тесты для API
- E2E тесты для критических сценариев
- Нагрузочное тестирование

---

## Этапы разработки (Roadmap)

### MVP (Минимально жизнеспособный продукт)
1. Регистрация и авторизация по email
2. Создание объявлений (товары с фото)
3. Простой поиск товаров (текст, категория, цена)
4. Бронирование (заявки и подтверждения)
5. Чат между пользователями
6. Базовые in-app уведомления
7. Управление календарем доступности

### Версия 1.0
1. Онлайн-оплата через платежные системы
2. Эскроу-счета для безопасных транзакций
3. Рейтинги и отзывы
4. Верификация пользователей (email, телефон)
5. Расширенный поиск (Elasticsearch, геолокация)
6. Email и Push уведомления
7. OAuth авторизация (Google, Apple)
8. Мобильное приложение (iOS/Android)

### Версия 2.0
1. Система разрешения споров
2. Поддержка пользователей (тикеты, FAQ)
3. Продвинутая аналитика
4. Рекомендательная система
5. Социальные функции
6. API для партнеров

---

## Развертывание

### Требования к серверу

Для MVP все компоненты размещаются на одном сервере:

- **Приложение**: FastAPI приложение
- **База данных**: MongoDB 
- **Файлы**: Локальное хранилище (папка `uploads/` или `static/`)
- **Веб-сервер**: nginx (для проксирования к FastAPI и раздачи статики) или встроенный в FastAPI

### Структура проекта (FastAPI)

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # Точка входа FastAPI
│   ├── config.py            # Конфигурация
│   ├── database.py          # Подключение к MongoDB (Motor)
│   ├── models/              # MongoDB модели/схемы
│   │   ├── user.py
│   │   ├── item.py
│   │   ├── rental.py
│   │   └── category.py
│   ├── schemas/             # Pydantic схемы для валидации
│   │   ├── user.py
│   │   ├── item.py
│   │   ├── rental.py
│   │   └── category.py
│   ├── routers/             # API роуты
│   │   ├── auth.py
│   │   ├── users.py
│   │   ├── items.py
│   │   ├── rentals.py
│   │   ├── categories.py
│   │   ├── messages.py
│   │   └── notifications.py
│   ├── crud/                # CRUD операции для коллекций
│   │   ├── users.py
│   │   ├── items.py
│   │   ├── rentals.py
│   │   └── categories.py
│   └── utils/               # Утилиты
│       ├── auth.py          # JWT, хеширование паролей
│       └── file_upload.py   # Загрузка файлов
├── uploads/                 # Загруженные файлы (изображения)
├── static/                  # Статические файлы (если нужно)
├── requirements.txt         # Зависимости Python
└── README.md
```

### Основные зависимости (requirements.txt)

```
fastapi
uvicorn[standard]
motor                      # асинхронный драйвер для MongoDB
pymongo                   # синхронный драйвер (для утилит, если нужно)
pydantic
python-jose[cryptography]  # для JWT
passlib[bcrypt]            # для хеширования паролей
python-multipart           # для загрузки файлов
```

### Хранение файлов

- Изображения товаров сохраняются в `uploads/items/`
- Аватары пользователей в `uploads/avatars/`
- Фото в сообщениях в `uploads/messages/`
- URL формируется как `/static/uploads/...` или через отдельный endpoint

---

## Контакты и документация

- Лендинг: [URL лендинга]
- API документация: [Swagger/OpenAPI] (автоматически генерируется FastAPI)
- Техническая поддержка: [email]

---

**Примечание**: Этот документ описывает требования на основе анализа лендинга. При разработке рекомендуется уточнить детали с продуктовой командой и провести дополнительное исследование рынка.

